---
title: "Cause of Death Explorer"
format:
  dashboard:
    theme:
      - default
      - custom.scss
server: shiny
---

```{r message=FALSE}
#| context: setup

library(tidyverse)
library(ggiraph)

source("scripts/fn.R")

vrd <- readRDS("data/vr_deaths_2014_2023.rds")
cod <- readRDS("data/cod_rankable.rds")
cod_colors <- readRDS("data/cod_colors.rds")
```

```{r}
source("scripts/selectors.R")
```

# {.sidebar}

```{r}
sliderInput(
  inputId = "nranks",
  label = "Number of ranks",
  min = 1,
  max = length(cod),
  value = 10,
  step = 1
)

sliderInput(
  inputId = "years",
  label = "Years",
  min = min(vrd$yod, na.rm = TRUE),
  max = max(vrd$yod, na.rm = TRUE),
  value = c(
    min(vrd$yod, na.rm = TRUE),
    max(vrd$yod, na.rm = TRUE)
  ),
  step = 1,
  sep = ""
)
```

#### Demographics

```{r}
selectInput(
  inputId = "age",
  label = "Age",
  choices = agelist
)

selectInput(
  inputId = "sex",
  label = "Sex",
  choices = sexlist
)

selectInput(
  inputId = "race",
  label = "Race",
  choices = racelist
)
```

# Plot

```{r}
plotOutput("plot")
```

```{r}
#| context: server

vrd2 <- reactive({
  req(
    input$nranks,
    input$years,
    input$age,
    input$sex
  )
  
  config_vrd(
    vrd,
    nranks = input$nranks,
    years = input$years,
    ages = unlist(strsplit(input$age, ";")),
    sex = unlist(strsplit(input$sex, ";")),
    race = input$race,
    palette = cod_colors
  )
})

output$plot <- renderPlot({
  req(vrd2())
  
  cod_bump_chart(vrd2())
})
```

