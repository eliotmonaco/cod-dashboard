---
title: "R Notebook"
output: html_notebook
---

# Setup and import data

```{r message=FALSE}
library(tidyverse)
library(sf)

source("fn.R")
```

Import vital records deaths dataset.

```{r}
vrd <- readRDS("../data/vr_deaths_2014_2024.rds")
```

Import CDC ICD code list.

```{r}
icd <- readxl::read_excel(
  "../data/allvalid2023-detailed-titles-headings.xlsx",
  skip = 6,
  .name_repair = setmeup::fix_colnames
)
```

Import list of rankable CODs.

```{r}
cod_cdc <- readRDS("../data/cod_rankable_cdc.rds")
cod_mod <- readRDS("../data/cod_rankable_mod.rds")
```

Import city council districts shapefile (2023).

```{r}
dir <- "City Council Districts Shapefile - Effective 2023_20251016"

f <- list.files(paste0("../data/", dir), ".shp$", full.names = TRUE)

dist <- st_read(f)
```

# Validate VR data

Validate `yod`.

```{r}
vrd |>
  filter(as.numeric(yod) < 2014 | as.numeric(yod) > 2024) |>
  nrow()
```

Validate `citylimit`.

```{r}
vrd |>
  count(citylimit)
```

Validate `age`.

```{r}
vrd |>
  filter(!as.numeric(age) %in% 0:120 | is.na(as.numeric(age))) |>
  nrow()
```

Validate `sex`.

```{r}
vrd |>
  count(sex)
```

Validate race variables.

```{r}
vars <- c(
  "racewht",
  "raceblk",
  "raceind",
  "raceasind",
  "racechin",
  "raceflip",
  "racejap",
  "racekor",
  "raceviet",
  "raceaoth",
  "racehaw",
  "raceguam",
  "racesamoa",
  "raceioth",
  "raceoth"
)

vrd |>
  stack(vars) |>
  count(values)
```

Validate race variables.

```{r}
vars <- c(
  "mexican",
  "puer",
  "cuban",
  "hother"
)

vrd |>
  stack(vars) |>
  count(values)
```

Validate `ed2010`.

```{r}
vrd |>
  count(ed2010)
```

Validate `pregnancy`.

```{r}
vrd |>
  count(pregnancy)
```

# Configure VR data

Configure deaths dataset.

```{r}
fmt <- paste0("ID%0", nchar(nrow(vrd)), "d")

vrd <- vrd |>
  mutate(
    yod = as.numeric(yod),
    age = as.numeric(age),
    rowid = sprintf(fmt, row_number()), .before = 1
  ) |>
  filter(citylimit == "Y")

# Clean ICD codes
vrd <- fix_vital_icd(vrd, "rowid")

# Validate ICD codes
vrd |>
  select(cod) |>
  filter(!grepl("^[[:upper:]]\\d{2,3}$", cod))
```

Add council district variable from council districts shapefile.

```{r}
df <- vrd |>
  select(rowid, reslon, reslat) |>
  drop_na(reslon, reslat) |>
  st_as_sf(coords = c("reslon", "reslat"))
```

```{r}
st_crs(df) <- st_crs(dist)

df <- df |>
  st_join(
    dist |>
      select(council_district = dist_id)
  )
```

```{r}
vrd <- vrd |>
  left_join(
    as.data.frame(df) |>
      select(-geometry),
    by = "rowid"
  )
```

Add COD title variable from CDC ICD-10 codes list.

```{r}
vrd <- match_cdc_icd(vrd, icd)
```

```{r}
vrd |>
  filter(is.na(icd_title))
```

Add rankable COD variable from NVSS list.

```{r}
# Create regex patterns
cod_cdc <- lapply(cod_cdc, \(x) {
  paste(paste0("^", sub("\\.", "", x)), collapse = "|")
})

# Get rankable COD categories
cod_ranked_cdc <- sapply(vrd$cod, match_rankable_icd, ls = cod_cdc)

# Check if any ICD code was matched to > 1 COD
any(sapply(cod_ranked_cdc, length) > 1)

# Add to `vrd`
vrd$cod_rankable_cdc <- cod_ranked_cdc

vrd <- vrd |>
  relocate(cod_rankable_cdc, .after = cod_matched_icd)
```

Add rankable COD variable based on NVSS list with accidental drug overdoses separated from other accidents.

```{r}
# Create regex patterns
cod_mod <- lapply(cod_mod, \(x) {
  paste(paste0("^", sub("\\.", "", x)), collapse = "|")
})

# Get rankable COD categories
cod_ranked_mod <- sapply(vrd$cod, match_rankable_icd, ls = cod_mod)

# Check if any ICD code was matched to > 1 COD
any(sapply(cod_ranked_mod, length) > 1)

# Add to `vrd`
vrd$cod_rankable_mod <- cod_ranked_mod

vrd <- vrd |>
  relocate(cod_rankable_mod, .after = cod_rankable_cdc)
```

# Create color palette

Assign color palette to rankable CODs.

```{r}
pal <- colorRampPalette(paletteer::paletteer_d("yarrr::basel"))

cod_ranked <- vrd |>
  count(cod_rankable_cdc) |>
  rename(cod = cod_rankable_cdc) |>
  bind_rows(
    vrd |>
      count(cod_rankable_mod) |>
      rename(cod = cod_rankable_mod)
  )

cod_ranked <- cod_ranked |>
  bind_rows(
    tibble(
      cod = names(cod_cdc)[!names(cod_cdc) %in% cod_ranked$cod],
      n = 0
    )
  ) |>
  distinct() |>
  arrange(desc(n)) |>
  drop_na(cod) |>
  pull(cod)

clr <- pal(length(cod_ranked))

i <- which(clr == "#C51C19")

clr <- c(clr[i:length(clr)], clr[1:(i - 1)])

l <- rep(letters[1:4], 20)[1:length(clr)]

sq <- sort(setNames(l, seq_along(l)))

clr <- clr[as.numeric(names(sq))]

cod_colors <- data.frame(
  cod = cod_ranked,
  colors = factor(clr, levels = clr)
)
```

Plot assigned colors.

```{r fig.width=10, fig.height=15}
cod_colors |>
  ggplot(aes(x = 1, y = colors, fill = colors)) +
  geom_bar(stat = "identity") +
  scale_fill_identity() +
  geom_text(
    aes(label = cod),
    position = position_nudge(x = -.5),
    color = "white",
    fontface = "bold"
  )
```

# Save

```{r}
saveRDS(vrd, "../data/vrd_db_dataset.rds")
saveRDS(cod_colors, "../data/cod_colors.rds")
```

