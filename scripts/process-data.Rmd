---
title: "R Notebook"
output: html_notebook
---

# Setup and import data

```{r message=FALSE}
library(tidyverse)
library(sf)

source("fn.R")
```

Import vital records deaths dataset.

```{r}
vrd <- readRDS("../data/vr_deaths_2014_2024.rds")
```

Import CDC ICD code list.

```{r}
icd <- readxl::read_excel(
  "../data/allvalid2023-detailed-titles-headings.xlsx",
  skip = 6,
  .name_repair = setmeup::fix_colnames
)
```

Import list of rankable CODs.

```{r}
rcod <- readRDS("../data/rankable_cod_categories.rds")
```

Import city council districts shapefile (2023).

```{r}
dir <- "City Council Districts Shapefile - Effective 2023_20251016"

f <- list.files(paste0("../data/", dir), ".shp$", full.names = TRUE)

dist <- st_read(f)
```

# Validate VR data

Validate `yod`.

```{r}
vrd |>
  filter(as.numeric(yod) < 2014 | as.numeric(yod) > 2024) |>
  nrow()
```

Validate `citylimit`.

```{r}
vrd |>
  count(citylimit)
```

Validate `age`.

```{r}
vrd |>
  filter(!as.numeric(age) %in% 0:120 | is.na(as.numeric(age))) |>
  nrow()
```

Validate `sex`.

```{r}
vrd |>
  count(sex)
```

Validate race variables.

```{r}
vars <- c(
  "racewht",
  "raceblk",
  "raceind",
  "raceasind",
  "racechin",
  "raceflip",
  "racejap",
  "racekor",
  "raceviet",
  "raceaoth",
  "racehaw",
  "raceguam",
  "racesamoa",
  "raceioth",
  "raceoth"
)

vrd |>
  stack(vars) |>
  count(values)
```

Validate race variables.

```{r}
vars <- c(
  "mexican",
  "puer",
  "cuban",
  "hother"
)

vrd |>
  stack(vars) |>
  count(values)
```

Validate `ed2010`.

```{r}
vrd |>
  count(ed2010)
```

Validate `pregnancy`.

```{r}
vrd |>
  count(pregnancy)
```

# Configure VR data

Configure deaths dataset.

```{r}
fmt <- paste0("ID%0", nchar(nrow(vrd)), "d")

vrd <- vrd |>
  mutate(
    yod = as.numeric(yod),
    age = as.numeric(age),
    rowid = sprintf(fmt, row_number()), .before = 1
  ) |>
  filter(citylimit == "Y")

# Clean ICD codes
vrd <- fix_vital_icd(vrd, "rowid")

# Validate ICD codes
vrd |>
  select(cod) |>
  filter(!grepl("^[[:upper:]]\\d{2,3}$", cod))
```

Add council district variable from council districts shapefile.

```{r}
df <- vrd |>
  select(rowid, reslon, reslat) |>
  drop_na(reslon, reslat) |>
  st_as_sf(coords = c("reslon", "reslat"))
```

```{r}
st_crs(df) <- st_crs(dist)

df <- df |>
  st_join(
    dist |>
      select(council_district = dist_id)
  )
```

```{r}
vrd <- vrd |>
  left_join(
    as.data.frame(df) |>
      select(-geometry),
    by = "rowid"
  )
```

Add COD title variable from CDC ICD-10 codes list.

```{r}
vrd <- match_cdc_icd(vrd, icd)
```

```{r}
vrd |>
  filter(is.na(icd_title))
```

Add rankable COD variables from NVSS list and modified NVSS list.

```{r}
vrd$rcod_cdc <- match_rankable_cod(vrd$cod, rcod$cdc)

vrd$rcod_mod <- match_rankable_cod(vrd$cod, rcod$mod)
```

Add alternative names for rankable CODs.

```{r}
cdc_alt <- setNames(rcod$cdc_alt$name2, rcod$cdc_alt$name1)
mod_alt <- setNames(rcod$mod_alt$name2, rcod$mod_alt$name1)

vrd$rcod_cdc_alt <- cdc_alt[vrd$rcod_cdc]
vrd$rcod_mod_alt <- mod_alt[vrd$rcod_mod]
```

Factorize and reorder.

```{r}
vrd <- vrd |>
  mutate(
    rcod_cdc = factor(rcod_cdc, levels = names(rcod$cdc)),
    rcod_mod = factor(rcod_mod, levels = names(rcod$mod)),
    rcod_cdc_alt = factor(rcod_cdc_alt, levels = rcod$cdc_alt$name2),
    rcod_mod_alt = factor(rcod_mod_alt, levels = rcod$mod_alt$name2)
  ) |>
  relocate(rcod_cdc, rcod_cdc_alt, rcod_mod, rcod_mod_alt, .before = cod)
```

# Create color palette

Assign color palette to rankable CODs.

```{r}
pal <- colorRampPalette(paletteer::paletteer_d("yarrr::basel"))

cod_ranked <- vrd |>
  count(rcod_cdc) |>
  rename(cod = rcod_cdc) |>
  bind_rows(
    vrd |>
      count(rcod_mod) |>
      rename(cod = rcod_mod)
  )

cod_ranked <- cod_ranked |>
  bind_rows(
    tibble(
      cod = names(rcod$cdc)[!names(rcod$cdc) %in% cod_ranked$cod],
      n = 0
    )
  ) |>
  distinct() |>
  arrange(desc(n)) |>
  drop_na(cod) |>
  pull(cod)

clr <- pal(length(cod_ranked))

i <- which(clr == "#C51C19")

clr <- c(clr[i:length(clr)], clr[1:(i - 1)])

l <- rep(letters[1:4], 20)[1:length(clr)]

sq <- sort(setNames(l, seq_along(l)))

clr <- clr[as.numeric(names(sq))]

rcod_colors <- data.frame(
  name1 = cod_ranked,
  color = factor(clr, levels = clr)
)

rcod_colors <- rcod_colors |>
  left_join(
    rcod$cdc_alt |>
      select(name1, name2),
    by = "name1"
  ) |>
  rows_update(
    rcod$mod_alt |>
      select(name1, name2),
    by = "name1"
  ) |>
  select(name1, name2, color)
```

Plot assigned colors.

```{r fig.width=10, fig.height=15}
rcod_colors |>
  ggplot(aes(x = 1, y = color, fill = color)) +
  geom_bar(stat = "identity") +
  scale_fill_identity() +
  geom_text(
    aes(label = name2),
    position = position_nudge(x = -.5),
    color = "white",
    fontface = "bold"
  )
```

# Save

```{r}
saveRDS(vrd, "../data/vrd_db_dataset.rds")
saveRDS(rcod_colors, "../data/rcod_colors.rds")
```

